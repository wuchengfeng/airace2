name: deploy
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Write env for production
        env:
          VITE_TEABLE_BASE_URL: ${{ secrets.VITE_TEABLE_BASE_URL }}
          VITE_TEABLE_API_TOKEN: ${{ secrets.VITE_TEABLE_API_TOKEN }}
          VITE_TEABLE_WORDTABLE_TABLE_ID: ${{ secrets.VITE_TEABLE_WORDTABLE_TABLE_ID }}
          VITE_TEABLE_WORDLISTS_TABLE_ID: ${{ secrets.VITE_TEABLE_WORDLISTS_TABLE_ID }}
          VITE_AI_PROVIDER: ${{ secrets.VITE_AI_PROVIDER }}
          VITE_VOLCES_ARK_BASE_URL: ${{ secrets.VITE_VOLCES_ARK_BASE_URL }}
          VITE_VOLCES_ARK_MODEL: ${{ secrets.VITE_VOLCES_ARK_MODEL }}
          VITE_VOLCES_ARK_API_KEY: ${{ secrets.VITE_VOLCES_ARK_API_KEY }}
          VITE_TAL_MLOPS_APP_ID: ${{ secrets.VITE_TAL_MLOPS_APP_ID }}
          VITE_TAL_MLOPS_APP_KEY: ${{ secrets.VITE_TAL_MLOPS_APP_KEY }}
          VITE_TAL_AI_BASE_URL: ${{ secrets.VITE_TAL_AI_BASE_URL }}
        run: |
          cat > .env.production << EOF
          VITE_TEABLE_BASE_URL=\${VITE_TEABLE_BASE_URL}
          VITE_TEABLE_API_TOKEN=\${VITE_TEABLE_API_TOKEN}
          VITE_TEABLE_WORDTABLE_TABLE_ID=\${VITE_TEABLE_WORDTABLE_TABLE_ID}
          VITE_TEABLE_WORDLISTS_TABLE_ID=\${VITE_TEABLE_WORDLISTS_TABLE_ID}
          VITE_AI_PROVIDER=\${VITE_AI_PROVIDER}
          VITE_VOLCES_ARK_BASE_URL=\${VITE_VOLCES_ARK_BASE_URL}
          VITE_VOLCES_ARK_MODEL=\${VITE_VOLCES_ARK_MODEL}
          VITE_VOLCES_ARK_API_KEY=\${VITE_VOLCES_ARK_API_KEY}
          VITE_TAL_MLOPS_APP_ID=\${VITE_TAL_MLOPS_APP_ID}
          VITE_TAL_MLOPS_APP_KEY=\${VITE_TAL_MLOPS_APP_KEY}
          VITE_TAL_AI_BASE_URL=\${VITE_TAL_AI_BASE_URL}
          EOF
      - run: npm ci
      - run: npm run test:unit
      - run: npm run build
      - name: Upload dist to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "dist/*"
          target: "/var/www/airace2"
          strip_components: 1
          overwrite: true
      - name: Reload nginx
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            sudo systemctl reload nginx
